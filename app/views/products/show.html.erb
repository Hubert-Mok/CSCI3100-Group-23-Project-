<% content_for :title, "#{@product.title} â€“ CUHK Marketplace" %>

<%= turbo_stream_from @product %>

<div class="product-show">
  <div class="product-show-image">
    <% if @product.thumbnail.attached? %>
      <%= image_tag @product.thumbnail.variant(resize_to_limit: [800, 600]), class: "show-thumbnail", alt: @product.title %>
    <% else %>
      <div class="show-thumbnail-placeholder">
        <span>No Image</span>
      </div>
    <% end %>
  </div>

  <div class="product-show-details">
    <div class="show-header">
      <%= render "products/status_badge", product: @product %>
      <% if @product.gift? %>
        <span class="listing-type-badge">Gift</span>
      <% end %>
      <% if @product.category.present? %>
        <span class="category-tag"><%= @product.category %></span>
      <% end %>
    </div>

    <h1 class="show-title"><%= @product.title %></h1>

    <div class="show-price">
      <% if @product.gift? %>
        <span class="price-free">Free</span>
      <% else %>
        <span class="price-amount">HK$<%= number_with_precision(@product.price, precision: 2) %></span>
      <% end %>
    </div>

    <div class="show-section">
      <h2 class="show-section-title">Description</h2>
      <p class="show-description"><%= simple_format(@product.description) %></p>
    </div>

    <div class="show-section">
      <h2 class="show-section-title">Seller</h2>
      <p class="show-seller"><%= @product.user.username %> &middot; <%= @product.user.college_affiliation %></p>
    </div>

    <div class="show-actions">
      <% if logged_in? && current_user != @product.user %>
        <%= button_to conversations_path(product_id: @product.id),
                      method: :post,
                      class: "btn-primary btn-chat" do %>
          ðŸ’¬ Chat with Seller
        <% end %>
        <% if @liked %>
          <%= button_to product_like_path(@product), method: :delete, class: "btn-like btn-liked", form: { data: { turbo: false } } do %>
            â™¥ Unlike (<%= @product.likes_count %>)
          <% end %>
        <% else %>
          <%= button_to product_like_path(@product), method: :post, class: "btn-like", form: { data: { turbo: false } } do %>
            â™¡ Like (<%= @product.likes_count %>)
          <% end %>
        <% end %>
      <% end %>

      <% if logged_in? && current_user == @product.user %>
        <span class="like-count-static">â™¡ <%= @product.likes_count %> <%= @product.likes_count == 1 ? "like" : "likes" %></span>
        <%= link_to "Edit Listing", edit_product_path(@product), class: "btn-secondary btn-edit" %>
        <%= button_to "Remove listing", product_path(@product), method: :delete,
                      class: "btn-secondary btn-delete",
                      data: { turbo_confirm: "Are you sure you want to remove this listing?" } %>
      <% end %>

      <% unless logged_in? %>
        <span class="like-count-static">â™¡ <%= @product.likes_count %> <%= @product.likes_count == 1 ? "like" : "likes" %></span>
      <% end %>
    </div>

    <p class="show-meta">Listed <%= time_ago_in_words(@product.created_at) %> ago</p>
  </div>
</div>

<div class="show-back">
  <%= link_to "â† Back to listings", root_path %>
</div>
